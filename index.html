<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>AdhanSalat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.json" />
</head>
<body>
  <h1>üåΩ AdhanSalat - Horaires de pri√®re</h1>

  <label>Pays :
    <select id="countrySelector">
      <option value="">-- Choisir un pays --</option>
    </select>
  </label><br>

  <label>Ville :
    <select id="citySelector">
      <option value="">-- Choisir une ville --</option>
    </select>
  </label><br>

  <button id="gpsBtn">üìç Utiliser ma position</button><br><br>

  <label>Latitude : <input id="lat" type="number" value="43.61" step="0.01" /></label><br>
  <label>Longitude : <input id="lon" type="number" value="3.87" step="0.01" /></label><br>
  <label>Angle Fajr : <input id="fajr" type="number" value="18" /></label><br>
  <label>Angle Isha : <input id="isha" type="number" value="17" /></label><br>
  <label>OU √©cart Isha (minutes) : <input id="ishaInterval" type="number" value="0" /></label><br><br>

  <h3>Ajustements manuels (¬±15min)</h3>
  <label>Fajr : <select id="fajrAdjust"></select></label><br>
  <label>Dhuhr : <select id="dhuhrAdjust"></select></label><br>
  <label>Asr : <select id="asrAdjust"></select></label><br>
  <label>Maghrib : <select id="maghribAdjust"></select></label><br>
  <label>Isha : <select id="ishaAdjust"></select></label><br><br>

  <button onclick="calculate()">Calculer</button>

  <h2>Horaires :</h2>
  <ul id="times"></ul>

  <script src="adhan.js"></script>
  <script>
    let citiesData = {};

    fetch('countries.json')
      .then(res => res.json())
      .then(data => {
        citiesData = data;
        const countrySelect = document.getElementById('countrySelector');
        for (const country in data) {
          const opt = document.createElement('option');
          opt.value = country;
          opt.textContent = country;
          countrySelect.appendChild(opt);
        }
      });

    document.getElementById("countrySelector").addEventListener("change", function () {
      const country = this.value;
      const citySelect = document.getElementById('citySelector');
      citySelect.innerHTML = '<option value="">-- Choisir une ville --</option>';

      if (citiesData[country]) {
        for (const city in citiesData[country]) {
          const opt = document.createElement('option');
          opt.value = city;
          opt.textContent = city;
          citySelect.appendChild(opt);
        }
      }
    });

    document.getElementById("citySelector").addEventListener("change", function () {
      const country = document.getElementById("countrySelector").value;
      const city = this.value;
      if (citiesData[country] && citiesData[country][city]) {
        const { lat, lon } = citiesData[country][city];
        document.getElementById("lat").value = lat;
        document.getElementById("lon").value = lon;
        calculate();
      }
    });

    function formatTime(date) {
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function generateAdjustmentOptions(id) {
      const select = document.getElementById(id);
      select.innerHTML = "";
      for (let i = -15; i <= 15; i++) {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = (i > 0 ? "+" : "") + i + " min";
        if (i === 0) opt.selected = true;
        select.appendChild(opt);
      }
    }

    function calculate() {
      const lat = parseFloat(document.getElementById("lat").value);
      const lon = parseFloat(document.getElementById("lon").value);
      const fajrAngle = parseFloat(document.getElementById("fajr").value);
      const ishaAngle = parseFloat(document.getElementById("isha").value);
      const ishaInterval = parseInt(document.getElementById("ishaInterval").value);

      const coordinates = new adhan.Coordinates(lat, lon);
      const params = new adhan.CalculationParameters("Other", fajrAngle, ishaAngle);
      params.madhab = adhan.Madhab.Shafi;

      if (ishaInterval > 0) {
        params.ishaAngle = 0;
        params.ishaInterval = ishaInterval;
      }

      params.adjustments.fajr = parseInt(document.getElementById("fajrAdjust").value);
      params.adjustments.dhuhr = parseInt(document.getElementById("dhuhrAdjust").value);
      params.adjustments.asr = parseInt(document.getElementById("asrAdjust").value);
      params.adjustments.maghrib = parseInt(document.getElementById("maghribAdjust").value);
      params.adjustments.isha = parseInt(document.getElementById("ishaAdjust").value);

      const date = new Date();
      const prayerTimes = new adhan.PrayerTimes(coordinates, date, params);

      const times = {
        Fajr: formatTime(prayerTimes.fajr),
        Sunrise: formatTime(prayerTimes.sunrise),
        Dhuhr: formatTime(prayerTimes.dhuhr),
        Asr: formatTime(prayerTimes.asr),
        Maghrib: formatTime(prayerTimes.maghrib),
        Isha: formatTime(prayerTimes.isha)
      };

      const list = document.getElementById("times");
      list.innerHTML = "";
      for (const [name, time] of Object.entries(times)) {
        const li = document.createElement("li");
        li.textContent = `${name} : ${time}`;
        list.appendChild(li);
      }
    }

    window.onload = () => {
      ["fajrAdjust", "dhuhrAdjust", "asrAdjust", "maghribAdjust", "ishaAdjust"].forEach(generateAdjustmentOptions);
      calculate();
    };

    document.getElementById("ishaInterval").addEventListener("input", e => {
      document.getElementById("isha").disabled = parseInt(e.target.value) > 0;
    });
    document.getElementById("isha").addEventListener("input", e => {
      document.getElementById("ishaInterval").disabled = parseFloat(e.target.value) > 0;
    });

    document.getElementById("gpsBtn").addEventListener("click", () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const { latitude, longitude } = pos.coords;
          document.getElementById("lat").value = latitude.toFixed(4);
          document.getElementById("lon").value = longitude.toFixed(4);
          calculate();
        }, err => {
          alert("Erreur GPS : " + err.message);
        });
      } else {
        alert("G√©olocalisation non support√©e");
      }
    });
  </script>
</body>
</html>
