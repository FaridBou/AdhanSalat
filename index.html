<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#ffffff">
  <title>AdhanSalat</title>
  <link rel="manifest" href="manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(reg => console.log('Service worker enregistr√©:', reg.scope))
          .catch(err => console.log('√âchec enregistrement service worker:', err));
      });
    }
  </script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 1em;
      background: var(--bg-color);
      color: var(--text-color);
      transition: background 0.3s, color 0.3s;
    }
    header {
      text-align: center;
      margin-bottom: 1em;
    }
    .prayer-time {
      display: flex;
      justify-content: space-between;
      padding: 0.5em 1em;
      background: var(--card-bg);
      margin-bottom: 0.5em;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    label, input, select {
      display: block;
      width: 100%;
      margin-top: 0.5em;
    }
    .settings {
      background: var(--card-bg);
      padding: 1em;
      margin-top: 1em;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .error {
      color: red;
      text-align: center;
      margin-bottom: 1em;
    }
    .debug {
      background: #ffe0e0;
      padding: 0.5em;
      margin-top: 1em;
      font-size: 0.9em;
      color: #900;
    }
    .dark {
      --bg-color: #111;
      --text-color: #f1f1f1;
      --card-bg: #222;
    }
    .light {
      --bg-color: #f9f9f9;
      --text-color: #333;
      --card-bg: #fff;
    }
  </style>
</head>
<body>
  <header>
    <h1>AdhanSalat</h1>
    <p id="subtitle">Horaires de pri√®re personnalisables</p>
    <label>Langue:
      <select id="langSelect">
        <option value="fr">Fran√ßais</option>
        <option value="en">English</option>
        <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
      </select>
    </label>
    <label>Th√®me:
      <select id="themeSelect">
        <option value="auto">Auto</option>
        <option value="light">Clair</option>
        <option value="dark">Sombre</option>
      </select>
    </label>
  </header>

  <div id="error" class="error"></div>
  <div id="times"></div>
  <div id="qibla"></div>

  <div class="settings">
    <h2>R√©glages</h2>
    <label>Angle Fajr (¬∞): <input type="number" id="angleFajr" value="18"></label>
    <label>Angle Isha (¬∞): <input type="number" id="angleIsha" value="17"></label>
    <label>D√©calage Isha apr√®s Maghreb (minutes): <input type="number" id="maghribToIsha" value="80"></label>
    <label>Latitude (si GPS d√©sactiv√©): <input type="number" id="latitude" value="43.8367"></label>
    <label>Longitude (si GPS d√©sactiv√©): <input type="number" id="longitude" value="4.3601"></label>
    <button onclick="calculateTimesManual()">Mettre √† jour</button>
  </div>

  <div id="debug" class="debug"></div>

  <script src="adhan.js"></script>
  <script>
    const themeSelect = document.getElementById("themeSelect");
    const langSelect = document.getElementById("langSelect");

    function applyTheme(mode) {
      const html = document.documentElement;
      if (mode === "dark") html.className = "dark";
      else if (mode === "light") html.className = "light";
      else html.className = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
    }
    themeSelect.addEventListener("change", e => applyTheme(e.target.value));
    applyTheme(themeSelect.value);

    langSelect.addEventListener("change", e => {
      const lang = e.target.value;
      const subtitle = document.getElementById("subtitle");
      if (lang === "fr") subtitle.textContent = "Horaires de pri√®re personnalisables";
      if (lang === "en") subtitle.textContent = "Customizable Prayer Times";
      if (lang === "ar") subtitle.textContent = "ŸÖŸàÿßŸÇŸäÿ™ ÿßŸÑÿµŸÑÿßÿ© ŸÇÿßÿ®ŸÑÿ© ŸÑŸÑÿ™ÿÆÿµŸäÿµ";
    });

    function showError(message) {
      document.getElementById('error').textContent = message;
    }
    function showDebug(info) {
      document.getElementById('debug').textContent = info;
    }
    function formatTime(time) {
      return time.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
    }
    function calculateQibla(coords) {
      const makkah = new adhan.Coordinates(21.4225, 39.8262);
      const qiblaAngle = adhan.Qibla(new adhan.Coordinates(coords.latitude, coords.longitude));
      document.getElementById("qibla").innerHTML = `<p>üß≠ Qibla: ${qiblaAngle.toFixed(1)}¬∞</p>`;
    }
    function calculateTimes(coords) {
      try {
        const params = adhan.CalculationMethod.Other();
        params.fajrAngle = parseFloat(document.getElementById('angleFajr').value);
        params.ishaAngle = parseFloat(document.getElementById('angleIsha').value);
        params.maghribAngle = null;

        const date = new Date();
        const location = new adhan.Coordinates(coords.latitude, coords.longitude);
        const prayerTimes = new adhan.PrayerTimes(location, date, params);

        const maghribTime = prayerTimes.maghrib;
        const ishaOffset = parseInt(document.getElementById('maghribToIsha').value);
        const customIsha = new Date(maghribTime.getTime() + ishaOffset * 60000);

        const now = new Date();
        const times = [
          {name: "Fajr", time: prayerTimes.fajr},
          {name: "Dhuhr", time: prayerTimes.dhuhr},
          {name: "Asr", time: prayerTimes.asr},
          {name: "Maghrib", time: prayerTimes.maghrib},
          {name: "Isha", time: customIsha},
        ];
        const current = times.slice().reverse().find(p => now >= p.time) || {name: "-", time: now};
        const next = times.find(p => now < p.time) || {name: "-", time: now};
        const remaining = Math.max(0, Math.floor((next.time - now) / 60000));

        document.getElementById('times').innerHTML =
          `<p>üìå Pri√®re actuelle : <strong>${current.name}</strong></p>
           <p>‚è≠Ô∏è Prochaine : <strong>${next.name}</strong> dans ${remaining} min</p>` +
          times.map(p => `<div class="prayer-time"><strong>üïã ${p.name}</strong><span>${formatTime(p.time)}</span></div>`).join('');

        showDebug(`Position utilis√©e: latitude ${coords.latitude}, longitude ${coords.longitude}`);
        calculateQibla(coords);

        if (Notification.permission === "granted" && remaining <= 5 && remaining > 0) {
          new Notification("Prochaine pri√®re dans " + remaining + " minutes: " + next.name);
          if (navigator.vibrate) navigator.vibrate([100, 200, 100]);
        }
      } catch (err) {
        showError("Erreur lors du calcul des horaires.");
        showDebug(err.toString());
      }
    }

    function calculateTimesManual() {
      const lat = parseFloat(document.getElementById('latitude').value);
      const lon = parseFloat(document.getElementById('longitude').value);
      calculateTimes({ latitude: lat, longitude: lon });
    }

    window.onload = () => {
      if (!navigator.geolocation) {
        showError("G√©olocalisation non support√©e. Utilisation de la position manuelle.");
        calculateTimesManual();
      } else {
        navigator.geolocation.getCurrentPosition(
          pos => calculateTimes(pos.coords),
          err => {
            showError("G√©olocalisation refus√©e. Utilisation de la position manuelle.");
            calculateTimesManual();
          }
        );
      }

      if (Notification.permission !== "granted") {
        Notification.requestPermission();
      }
    };
  </script>
</body>
</html>
