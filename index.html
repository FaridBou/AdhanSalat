<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Adhan O'Salat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.json" />
</head>
<body>
  <h1>üåΩ Adhan O'Salat - Horaires de pri√®re</h1>

  <label>Pays :
    <select id="countrySelector">
      <option value="">-- Choisir un pays --</option>
    </select>
  </label><br>
  
  <label>Ville :
    <select id="citySelector">
      <option value="">-- Choisir une ville --</option>
    </select>
  </label><br>

  <button id="gpsBtn">üìç Utiliser ma position</button><br><br>

  <label>Latitude : <input id="lat" type="number" value="43.61" step="0.01" /></label><br>
  <label>Longitude : <input id="lon" type="number" value="3.87" step="0.01" /></label><br>
  <label>Angle Fajr : <input id="fajr" type="number" value="18" /></label><br>
  <label>Angle Isha : <input id="isha" type="number" value="17" /></label><br>
  <label>OU √©cart Isha (minutes) : <input id="ishaInterval" type="number" value="0" /></label><br><br>

  <h3>Ajustements manuels (¬±15min)</h3>
  <label>Fajr : <select id="fajrAdjust"></select></label><br>
  <label>Dhuhr : <select id="dhuhrAdjust"></select></label><br>
  <label>Asr : <select id="asrAdjust"></select></label><br>
  <label>Maghrib : <select id="maghribAdjust"></select></label><br>
  <label>Isha : <select id="ishaAdjust"></select></label><br><br>

  <button onclick="calculate()">Calculer</button>

  <h2>Horaires :</h2>
  <ul id="times"></ul>

  <script src="adhan.js"></script>
  <script>
    let citiesData = {}; // contiendra toutes les villes FR (nom ‚Üí [lat, lon])

    // Charger la liste des villes (fichier .json)
    fetch("cities.json")
      .then(res => res.json())
      .then(data => {
        citiesData = data;
        const citySelect = document.getElementById("citySelector");
        Object.entries(citiesData).forEach(([city, coords]) => {
          const opt = document.createElement("option");
          opt.value = coords.join(",");
          opt.textContent = city;
          citySelect.appendChild(opt);
        });
      });

    // Calcul de la distance Haversine
    function distance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2) ** 2;
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
    }

    document.getElementById("gpsBtn").addEventListener("click", () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const { latitude, longitude } = pos.coords;
          document.getElementById("lat").value = latitude.toFixed(4);
          document.getElementById("lon").value = longitude.toFixed(4);

          let closestCity = null;
          let minDist = Infinity;
          for (const [city, [clat, clon]] of Object.entries(citiesData)) {
            const dist = distance(latitude, longitude, clat, clon);
            if (dist < minDist) {
              minDist = dist;
              closestCity = { name: city, coords: [clat, clon] };
            }
          }

          if (closestCity) {
            const citySelect = document.getElementById("citySelector");
            citySelect.value = closestCity.coords.join(",");
            citySelect.dispatchEvent(new Event("change"));
          }

        }, err => {
          alert("Erreur GPS : " + err.message);
        });
      } else {
        alert("G√©olocalisation non support√©e");
      }
    });

    document.getElementById("citySelector").addEventListener("change", function () {
      const [lat, lon] = this.value.split(",");
      document.getElementById("lat").value = lat;
      document.getElementById("lon").value = lon;
      calculate();
    });

    function formatTime(date) {
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function generateAdjustmentOptions(id) {
      const select = document.getElementById(id);
      select.innerHTML = "";
      for (let i = -15; i <= 15; i++) {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = (i > 0 ? "+" : "") + i + " min";
        if (i === 0) opt.selected = true;
        select.appendChild(opt);
      }
    }

    function calculate() {
      const lat = parseFloat(document.getElementById("lat").value);
      const lon = parseFloat(document.getElementById("lon").value);
      const fajrAngle = parseFloat(document.getElementById("fajr").value);
      const ishaAngle = parseFloat(document.getElementById("isha").value);
      const ishaInterval = parseInt(document.getElementById("ishaInterval").value);

      const coordinates = new adhan.Coordinates(lat, lon);
      const params = new adhan.CalculationParameters("Other", fajrAngle, ishaAngle);
      params.madhab = adhan.Madhab.Shafi;

      if (ishaInterval > 0) {
        params.ishaAngle = 0;
        params.ishaInterval = ishaInterval;
      }

      params.adjustments.fajr = parseInt(document.getElementById("fajrAdjust").value);
      params.adjustments.dhuhr = parseInt(document.getElementById("dhuhrAdjust").value);
      params.adjustments.asr = parseInt(document.getElementById("asrAdjust").value);
      params.adjustments.maghrib = parseInt(document.getElementById("maghribAdjust").value);
      params.adjustments.isha = parseInt(document.getElementById("ishaAdjust").value);

      const date = new Date();
      const prayerTimes = new adhan.PrayerTimes(coordinates, date, params);

      const times = {
        Fajr: formatTime(prayerTimes.fajr),
        Sunrise: formatTime(prayerTimes.sunrise),
        Dhuhr: formatTime(prayerTimes.dhuhr),
        Asr: formatTime(prayerTimes.asr),
        Maghrib: formatTime(prayerTimes.maghrib),
        Isha: formatTime(prayerTimes.isha)
      };

      const list = document.getElementById("times");
      list.innerHTML = "";
      for (const [name, time] of Object.entries(times)) {
        const li = document.createElement("li");
        li.textContent = `${name} : ${time}`;
        list.appendChild(li);
      }
    }

    window.onload = () => {
      ["fajrAdjust", "dhuhrAdjust", "asrAdjust", "maghribAdjust", "ishaAdjust"].forEach(generateAdjustmentOptions);
      calculate();
    };

    document.getElementById("ishaInterval").addEventListener("input", e => {
      document.getElementById("isha").disabled = parseInt(e.target.value) > 0;
    });
    document.getElementById("isha").addEventListener("input", e => {
      document.getElementById("ishaInterval").disabled = parseFloat(e.target.value) > 0;
    });
  </script>
</body>
</html>
